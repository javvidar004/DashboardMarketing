{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="Dashboard">
    <meta name="keyword" content="Dashboard, Bootstrap, Admin, Template, Theme, Responsive, Fluid, Retina">

    <title>{{ platform_name }} - Análisis Detallado</title>

    <link href="{% static 'assets/css/bootstrap.css' %}" rel="stylesheet">
    <link href="{% static 'assets/font-awesome/css/font-awesome.css' %}" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="{% static 'assets/css/zabuto_calendar.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'assets/js/gritter/css/jquery.gritter.css' %}" />
    <link rel="stylesheet" type="text/css" href="{% static 'assets/lineicons/style.css' %}">

    <link href="{% static 'assets/css/style.css' %}" rel="stylesheet">
    <link href="{% static 'assets/css/style-responsive.css' %}" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    </head>

  <body>

  <section id="container" >
      <header class="header black-bg">
                <div class="sidebar-toggle-box">
                    <div class="fa fa-bars tooltips" data-placement="right" data-original-title="Toggle Navigation"></div>
                </div>
              <a href="{% url 'main' %}" class="logo"><b>ANÁLISIS DE {{ titulo }}</b></a>
              <div class="top-menu">
                 </div>
          </header>
        <aside>
            <div id="sidebar"  class="nav-collapse ">
                <ul class="sidebar-menu" id="nav-accordion">
                    <li class="mt">
                        <a href="{% url 'main' %}">
                            <i class="fa fa-dashboard"></i>
                            <span>Main Dashboard</span>
                        </a>
                    </li>

                    <li class="sub-menu">
                        <a href="javascript:;" {% if request.resolver_match.url_name == 'detailPlatform' %}class="active"{% endif %}>
                            <i class="fa fa-desktop"></i>
                            <span>Social Media Platforms</span>
                        </a>
                        <ul class="sub">
                          {% for x in redesSociales %}
                              <li {% if x.socialm_id == platform_id %}class="active"{% endif %}>
                                  <a href="{% url 'detailPlatform' x.socialm_id %}">{{ x.socialm_name }}</a>
                              </li>
                          {% endfor %}
                        </ul>
                    </li>

                    <li class="sub-menu">
                        <a href="javascript:;">
                            <i class="fa fa-cloud"></i>
                            <span>Countries</span>
                        </a>
                        <ul class="sub">
                          {% for x in paises %}
                              <li><a href="{% url 'detailContry' x.country_id %}">{{ x.country_name }}</a></li>
                          {% endfor %}
                        </ul>
                    </li>
                    <li class="sub-menu">
                        <a href="javascript:;">
                            <i class="fa fa-book"></i>
                            <span>Genders</span>
                        </a>
                        <ul class="sub">
                          {% for x in generos %}
                            <li><a href="{% url 'detailGender' x.gender_id %}">{{ x.gender }}</a></li>
                          {% endfor %}
                        </ul>
                    </li>
                    <li class="sub-menu">
                        <a href="javascript:;">
                            <i class="fa fa-tasks"></i>
                            <span>Entertainment</span>
                        </a>
                        <ul class="sub">
                          {% for x in tipoEntretenimiento %}
                            <li><a href="{% url 'detailEntertainment' x.entertainment_id %}">{{ x.entertainment_name }}</a></li>
                          {% endfor %}
                        </ul>
                    </li>
                </ul></div>
        </aside><section id="main-content">
          <section class="wrapper">

              <div class="row">
                  <div class="col-lg-12 main-chart"> <div class="row mt">
                        <div class="col-lg-12">
                          <h3 style="padding-left: 15px;"><i class="fa fa-angle-right"></i> Análisis Detallado: {{ platform_name }}</h3>
                        </div>
                      </div>

                      <div class="row mt">
                        <div class="col-md-6 col-sm-6 mb"> <div class="white-panel pn" style="height: 350px;"> <div class="white-header">
                                    <h5>Distribución por Edad</h5>
                                </div>
                                <div style="height: 280px; padding: 10px;">
                                    <canvas id="ageChart"></canvas>
                                </div>
                            </div>
                        </div><div class="col-md-6 col-sm-6 mb">
                            <div class="white-panel pn" style="height: 350px;">
                                <div class="white-header">
                                    <h5>Distribución por Género</h5>
                                </div>
                                <div style="height: 280px; padding: 10px;">
                                     <canvas id="genderChart"></canvas>
                                </div>
                            </div>
                        </div></div><div class="row mt">
                        <div class="col-md-6 col-sm-6 mb">
                            <div class="white-panel pn" style="height: 350px;">
                                <div class="white-header">
                                    <h5>Top 10 Países</h5>
                                </div>
                                <div style="height: 280px; padding: 10px;">
                                    <canvas id="countryChart"></canvas>
                                </div>
                            </div>
                        </div><div class="col-md-6 col-sm-6 mb">
                            <div class="white-panel pn" style="height: 350px;">
                                <div class="white-header">
                                    <h5>Top 10 Ocupaciones</h5>
                                </div>
                                 <div style="height: 280px; padding: 10px;">
                                    <canvas id="occupationChart"></canvas>
                                 </div>
                            </div>
                        </div></div></div></div></section>
      </section>
      <footer class="site-footer">
          <div class="text-center">
              2014 - Alvarez.is <a href="#" class="go-top"> <i class="fa fa-angle-up"></i>
              </a>
          </div>
      </footer>
      </section>

    <script src="{% static 'assets/js/jquery.js' %}"></script>
    <script src="{% static 'assets/js/jquery-1.8.3.min.js' %}"></script> <script src="{% static 'assets/js/bootstrap.min.js' %}"></script>
    <script class="include" type="text/javascript" src="{% static 'assets/js/jquery.dcjqaccordion.2.7.js' %}"></script>
    <script src="{% static 'assets/js/jquery.scrollTo.min.js' %}"></script>
    <script src="{% static 'assets/js/jquery.nicescroll.js' %}" type="text/javascript"></script>
    <script src="{% static 'assets/js/jquery.sparkline.js' %}"></script> <script src="{% static 'assets/js/common-scripts.js' %}"></script>

    <script>
        // Obtener el ID de la plataforma desde el contexto de Django
        const platformId = {{ platform_id }};

        // URLs de las APIs
        const ageApiUrl = `/api/smp/${platformId}/age_distribution/`;
        const genderApiUrl = `/api/smp/${platformId}/gender_distribution/`;
        const countryApiUrl = `/api/smp/${platformId}/top_countries/`;
        const occupationApiUrl = `/api/smp/${platformId}/top_occupations/`;

        // Colores (ajusta según tu tema)
        const backgroundColors = [
            'rgba(104, 223, 240, 0.7)', // Un celeste similar al tema
            'rgba(75, 192, 192, 0.7)',
            'rgba(255, 159, 64, 0.7)',
            'rgba(255, 99, 132, 0.7)',
            'rgba(54, 162, 235, 0.7)',
            'rgba(255, 206, 86, 0.7)',
            'rgba(153, 102, 255, 0.7)',
            'rgba(199, 199, 199, 0.7)'
             // Añade más si esperas más de 8 barras/segmentos
        ];
        const borderColors = backgroundColors.map(color => color.replace('0.7', '1'));

        // Función genérica para crear gráficos
        function createChart(canvasId, apiUrl, chartType, label) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) {
                console.error(`Canvas element with ID ${canvasId} not found.`);
                return; // Salir si el canvas no existe
            }
            const chartContext = ctx.getContext('2d');

            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                    return response.json();
                 })
                .then(data => {
                    if (!data || !data.labels || !data.data) {
                         console.error(`Data format error for ${canvasId}:`, data);
                         chartContext.font = '14px Arial'; chartContext.fillStyle = '#808080'; chartContext.textAlign = 'center';
                         chartContext.fillText('Error cargando datos', ctx.width / 2, ctx.height / 2);
                         return;
                    }
                    if (data.data.length === 0) { // Mostrar mensaje si no hay datos
                         chartContext.font = '14px Arial'; chartContext.fillStyle = '#808080'; chartContext.textAlign = 'center';
                         chartContext.fillText('No hay datos disponibles para esta plataforma', ctx.width / 2, ctx.height / 2);
                         return;
                    }

                    // Destruir gráfico existente si lo hay (para evitar solapamientos en recargas rápidas)
                    let existingChart = Chart.getChart(ctx);
                    if (existingChart) {
                        existingChart.destroy();
                    }

                    new Chart(chartContext, {
                        type: chartType,
                        data: {
                            labels: data.labels,
                            datasets: [{
                                label: label,
                                data: data.data,
                                backgroundColor: backgroundColors.slice(0, data.labels.length),
                                borderColor: borderColors.slice(0, data.labels.length),
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false, // Clave para que el tamaño lo controle el div contenedor
                            scales: (chartType === 'bar' || chartType === 'line') ? {
                                y: { beginAtZero: true, ticks: { color: '#808080' } }, // Color de ticks
                                x: { ticks: { color: '#808080' } } // Color de ticks
                            } : {},
                            plugins: {
                                legend: {
                                    display: (chartType === 'pie' || chartType === 'doughnut') && data.labels.length > 1, // Leyenda para pie/doughnut
                                    position: 'top', // Posición de la leyenda
                                    labels: { color: '#808080' } // Color del texto de la leyenda
                                },
                                title: { // Título opcional dentro del gráfico
                                    display: false, // Puedes ponerlo en true si quitas el del panel
                                    text: label,
                                    color: '#666666'
                                }
                            }
                        }
                    });
                })
                .catch(error => {
                    console.error(`Error fetching data for ${canvasId}:`, error);
                     chartContext.font = '14px Arial'; chartContext.fillStyle = '#dc3545'; chartContext.textAlign = 'center';
                     chartContext.fillText('Error al cargar gráfico', ctx.width / 2, ctx.height / 2);
                });
        }

        // Llamar a la función para cada gráfico al cargar la página
        document.addEventListener('DOMContentLoaded', () => {
            // Usamos setTimeout para asegurar que el DOM esté completamente listo y los tamaños calculados
            setTimeout(() => {
                createChart('ageChart', ageApiUrl, 'bar', 'Usuarios por Edad');
                createChart('genderChart', genderApiUrl, 'doughnut', 'Usuarios por Género'); // Cambiado a doughnut
                createChart('countryChart', countryApiUrl, 'bar', 'Usuarios por País');
                createChart('occupationChart', occupationApiUrl, 'bar', 'Usuarios por Ocupación');
             }, 100); // Un pequeño retraso
        });
    </script>

  </body>
</html>