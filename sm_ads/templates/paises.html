{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="Dashboard">
    <meta name="keyword" content="Dashboard, Bootstrap, Admin, Template, Theme, Responsive, Fluid, Retina">

    <title>{{ country_name }} - Análisis Detallado</title>

    <link href="{% static 'assets/css/bootstrap.css' %}" rel="stylesheet">
    <link href="{% static 'assets/font-awesome/css/font-awesome.css' %}" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="{% static 'assets/css/zabuto_calendar.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'assets/js/gritter/css/jquery.gritter.css' %}" />
    <link rel="stylesheet" type="text/css" href="{% static 'assets/lineicons/style.css' %}">

    <link href="{% static 'assets/css/style.css' %}" rel="stylesheet">
    <link href="{% static 'assets/css/style-responsive.css' %}" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    </head>

  <body>

  <section id="container" >
      <header class="header black-bg">
                <div class="sidebar-toggle-box">
                    <div class="fa fa-bars tooltips" data-placement="right" data-original-title="Toggle Navigation"></div>
                </div>
              <a href="{% url 'main' %}" class="logo"><b>ANÁLISIS DE {{ titulo }}</b></a>
              <div class="top-menu">
              </div>
          </header>
        <aside>
            <div id="sidebar"  class="nav-collapse ">
                <ul class="sidebar-menu" id="nav-accordion">
                    <li class="mt">
                        <a href="{% url 'main' %}">
                            <i class="fa fa-dashboard"></i>
                            <span>Main Dashboard</span>
                        </a>
                    </li>

                    <li class="sub-menu">
                        <a href="javascript:;">
                            <i class="fa fa-desktop"></i>
                            <span>Social Media Platforms</span>
                        </a>
                        <ul class="sub">
                          {% for x in redesSociales %}
                              <li><a href="{% url 'detailPlatform' x.socialm_id %}">{{ x.socialm_name }}</a></li>
                          {% endfor %}
                        </ul>
                    </li>

                    <li class="sub-menu">
                        <a href="javascript:;" {% if request.resolver_match.url_name == 'detailContry' %}class="active"{% endif %}>
                            <i class="fa fa-cloud"></i>
                            <span>Countries</span>
                        </a>
                        <ul class="sub">
                          {% for x in paises %}
                              <li {% if x.country_id == country_id %}class="active"{% endif %}>
                                  <a href="{% url 'detailContry' x.country_id %}">{{ x.country_name }}</a>
                              </li>
                          {% endfor %}
                        </ul>
                    </li>
                    <li class="sub-menu">
                        <a href="javascript:;">
                            <i class="fa fa-book"></i>
                            <span>Genders</span>
                        </a>
                        <ul class="sub">
                          {% for x in generos %}
                            <li><a href="{% url 'detailGender' x.gender_id %}">{{ x.gender }}</a></li>
                          {% endfor %}
                        </ul>
                    </li>
                    <li class="sub-menu">
                        <a href="javascript:;">
                            <i class="fa fa-tasks"></i>
                            <span>Entertainment</span>
                        </a>
                        <ul class="sub">
                          {% for x in tipoEntretenimiento %}
                            <li><a href="{% url 'detailEntertainment' x.entertainment_id %}">{{ x.entertainment_name }}</a></li>
                          {% endfor %}
                        </ul>
                    </li>
                </ul></div>
        </aside><section id="main-content">
          <section class="wrapper">

              <div class="row">
                  <div class="col-lg-12 main-chart">

                      <div class="row mt">
                        <div class="col-lg-12">
                          <h3 style="padding-left: 15px;"><i class="fa fa-angle-right"></i> Análisis Detallado: {{ country_name }}</h3>
                        </div>
                      </div>

                      <div class="row mt">
                        <div class="col-md-6 col-sm-6 mb">
                            <div class="white-panel pn" style="height: 350px;">
                                <div class="white-header">
                                    <h5>Distribución por Edad en {{ country_name }}</h5>
                                </div>
                                <div style="height: 280px; padding: 10px;">
                                    <canvas id="countryAgeChart"></canvas>
                                </div>
                            </div>
                        </div><div class="col-md-6 col-sm-6 mb">
                            <div class="white-panel pn" style="height: 350px;">
                                <div class="white-header">
                                    <h5>Distribución por Género en {{ country_name }}</h5>
                                </div>
                                <div style="height: 280px; padding: 10px;">
                                     <canvas id="countryGenderChart"></canvas>
                                </div>
                            </div>
                        </div></div><div class="row mt">
                        <div class="col-md-6 col-sm-6 mb">
                            <div class="white-panel pn" style="height: 350px;">
                                <div class="white-header">
                                    <h5>Top 5 Redes Sociales en {{ country_name }}</h5>
                                </div>
                                <div style="height: 280px; padding: 10px;">
                                    <canvas id="countryPlatformChart"></canvas>
                                </div>
                            </div>
                        </div><div class="col-md-6 col-sm-6 mb">
                            <div class="white-panel pn" style="height: 350px;">
                                <div class="white-header">
                                    <h5>Top 5 Entretenimientos en {{ country_name }}</h5>
                                </div>
                                 <div style="height: 280px; padding: 10px;">
                                    <canvas id="countryEntertainmentChart"></canvas>
                                 </div>
                            </div>
                        </div></div><div class="row mt">
                        <div class="col-md-6 col-sm-6 mb">
                            <div class="white-panel pn" style="height: 350px;">
                                <div class="white-header">
                                    <h5>Tiempo Promedio Diario (Horas) en {{ country_name }}</h5>
                                </div>
                                <div style="height: 280px; padding: 10px;">
                                    <canvas id="countryTimeChart"></canvas>
                                </div>
                            </div>
                        </div><div class="col-md-6 col-sm-6 mb">
                            <div class="white-panel pn" style="height: 350px;">
                                <div class="white-header">
                                    <h5>Finanzas Promedio Mensual ($) en {{ country_name }}</h5>
                                </div>
                                 <div style="height: 280px; padding: 10px;">
                                    <canvas id="countryFinanceChart"></canvas>
                                 </div>
                            </div>
                        </div></div></div></div></section>
      </section>
      <footer class="site-footer">
          <div class="text-center">
               2014 - Alvarez.is <a href="#" class="go-top">
                  <i class="fa fa-angle-up"></i>
              </a>
          </div>
      </footer>
      </section>

    <script src="{% static 'assets/js/jquery.js' %}"></script>
    <script src="{% static 'assets/js/bootstrap.min.js' %}"></script>
    <script class="include" type="text/javascript" src="{% static 'assets/js/jquery.dcjqaccordion.2.7.js' %}"></script>
    <script src="{% static 'assets/js/jquery.scrollTo.min.js' %}"></script>
    <script src="{% static 'assets/js/jquery.nicescroll.js' %}" type="text/javascript"></script>

    <script src="{% static 'assets/js/common-scripts.js' %}"></script>

    <script>
        // Obtener el ID del país desde el contexto de Django
        const countryId = {{ country_id }};

        // URLs de las APIs
        const countryAgeApiUrl = `/api/country/${countryId}/age_distribution/`;
        const countryGenderApiUrl = `/api/country/${countryId}/gender_distribution/`;
        const countryPlatformApiUrl = `/api/country/${countryId}/top_platforms/`;
        const countryEntertainmentApiUrl = `/api/country/${countryId}/top_entertainment/`;
        const countryTimeApiUrl = `/api/country/${countryId}/sm_vs_ent_time/`;
        const countryFinanceApiUrl = `/api/country/${countryId}/income_spending/`;

        // Colores (ajusta según tu tema)
        const backgroundColors = [
            'rgba(104, 223, 240, 0.7)', 'rgba(75, 192, 192, 0.7)', 'rgba(255, 159, 64, 0.7)',
            'rgba(255, 99, 132, 0.7)',  'rgba(54, 162, 235, 0.7)', 'rgba(255, 206, 86, 0.7)',
            'rgba(153, 102, 255, 0.7)', 'rgba(199, 199, 199, 0.7)'
        ];
        const borderColors = backgroundColors.map(color => color.replace('0.7', '1'));

        // Función genérica para crear gráficos (adaptada de la anterior)
        function createCountryChart(canvasId, apiUrl, chartType, label = '', defaultOptions = {}) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) {
                console.error(`Canvas element with ID ${canvasId} not found.`);
                return;
            }
            const chartContext = ctx.getContext('2d');

            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                    return response.json();
                 })
                .then(data => {
                    if (!data || !data.labels || !data.data) {
                         console.error(`Data format error for ${canvasId}:`, data);
                         chartContext.font = '14px Arial'; chartContext.fillStyle = '#808080'; chartContext.textAlign = 'center';
                         chartContext.fillText('Error cargando datos', ctx.width / 2, ctx.height / 2);
                         return;
                    }
                     if (data.data.length === 0 || data.data.every(val => val === 0)) { // Verifica si hay datos válidos
                         chartContext.font = '14px Arial'; chartContext.fillStyle = '#808080'; chartContext.textAlign = 'center';
                         chartContext.fillText('No hay datos disponibles para este país', ctx.width / 2, ctx.height / 2);
                         return;
                    }

                    let existingChart = Chart.getChart(ctx);
                    if (existingChart) { existingChart.destroy(); }

                     // Opciones base para todos los gráficos
                    const baseOptions = {
                        responsive: true,
                        maintainAspectRatio: false,
                         plugins: {
                            legend: {
                                display: (chartType === 'pie' || chartType === 'doughnut') && data.labels.length > 1,
                                position: 'top',
                                labels: { color: '#808080' }
                            },
                            tooltip: { // Opciones de Tooltip
                                bodyColor: '#eee',
                                titleColor: '#eee',
                                backgroundColor: 'rgba(0, 0, 0, 0.7)',
                            }
                        }
                    };

                    // Opciones específicas de escalas para gráficos de barras/líneas
                     if (chartType === 'bar' || chartType === 'line') {
                        baseOptions.scales = {
                            y: { beginAtZero: true, ticks: { color: '#808080' }, grid: { color: 'rgba(200, 200, 200, 0.2)' } },
                            x: { ticks: { color: '#808080' }, grid: { color: 'rgba(200, 200, 200, 0.1)' } }
                        };
                        // Ocultar leyenda para gráficos de barras simples si el label principal es suficiente
                        if (!baseOptions.plugins.legend.display) {
                           baseOptions.plugins.legend.display = false;
                        }
                    }

                    // Fusionar opciones base con opciones específicas si se pasaron
                    const finalOptions = { ...baseOptions, ...defaultOptions };

                    new Chart(chartContext, {
                        type: chartType,
                        data: {
                            labels: data.labels,
                            datasets: [{
                                label: label || `Datos para ${canvasId}`, // Label por defecto
                                data: data.data,
                                backgroundColor: backgroundColors.slice(0, data.labels.length),
                                borderColor: borderColors.slice(0, data.labels.length),
                                borderWidth: 1
                            }]
                        },
                        options: finalOptions
                    });
                })
                .catch(error => {
                    console.error(`Error fetching data for ${canvasId}:`, error);
                     chartContext.font = '14px Arial'; chartContext.fillStyle = '#dc3545'; chartContext.textAlign = 'center';
                     chartContext.fillText('Error al cargar gráfico', ctx.width / 2, ctx.height / 2);
                });
        }

        // Llamar a la función para cada gráfico
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                createCountryChart('countryAgeChart', countryAgeApiUrl, 'bar', 'Usuarios');
                createCountryChart('countryGenderChart', countryGenderApiUrl, 'doughnut', 'Usuarios');
                createCountryChart('countryPlatformChart', countryPlatformApiUrl, 'pie', 'Usuarios');
                createCountryChart('countryEntertainmentChart', countryEntertainmentApiUrl, 'pie', 'Usuarios');
                // Gráficos con solo dos barras, podemos ocultar la leyenda explícitamente
                createCountryChart('countryTimeChart', countryTimeApiUrl, 'bar', 'Horas Promedio', { plugins: { legend: { display: false } } });
                createCountryChart('countryFinanceChart', countryFinanceApiUrl, 'bar', 'Monto Promedio ($)', { plugins: { legend: { display: false } } });
            }, 100);
        });
    </script>

  </body>
</html>